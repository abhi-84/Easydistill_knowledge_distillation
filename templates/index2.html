<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EasyDistill Stage 2 Training</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #f4f6fb;
      padding: 25px;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .top-controls {
      background: #ffffff;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .top-controls label { font-weight: 600; margin-right: 10px; }
    .button-group button {
      padding: 8px 15px; border: none; border-radius: 8px;
      background: #4a90e2; color: #fff; font-weight: 500;
      cursor: pointer; transition: 0.2s;
    }
    .button-group button:hover { background: #357abd; }
    .button-group button:disabled { background: #ccc; cursor: not-allowed; }
    .log-section {
      background: #ffffff; border-radius: 12px;
      padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .log-output {
      background: #1e1e1e; color: #eaeaea; padding: 12px;
      border-radius: 8px; height: 250px; overflow-y: auto;
      font-family: monospace; white-space: pre-wrap; margin-top: 10px;
    }
    .below-log {
      margin-top: 20px; background: #ffffff; border-radius: 12px;
      padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .below-log label { font-weight: 600; }
    .loading-spinner {
      display: none; border: 4px solid #ccc;
      border-top: 4px solid #4a90e2; border-radius: 50%;
      width: 25px; height: 25px; animation: spin 1s linear infinite; margin-left: 10px;
    }
    @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
    .conversation-area {
      margin-top: 25px; padding: 20px; border-radius: 12px;
      background: #ffffff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
    }
    .chat-input-group { display: flex; gap: 8px; margin-top: 10px; }
    .chat-input-group input {
      flex-grow: 1; padding: 8px; border-radius: 8px; border: 1px solid #ccc;
    }
    .chat-input-group button {
      padding: 8px 14px; background-color: #4caf50;
      color: white; border: none; border-radius: 8px; cursor: pointer;
    }
    .chat-input-group button:hover { background-color: #43a047; }
    .chat-output {
      margin-top: 10px; background: #f8f9fa; padding: 10px;
      border-radius: 8px; min-height: 100px; font-family: monospace;
    }
  </style>
</head>

<body>
  <h1>EasyDistill Stage 2 Training</h1>

  <div class="top-controls">
    <div>
      <label for="logits_file_input">Upload Logits File:</label>
      <input type="file" id="logits_file_input" />
    </div>
    <div>
      <label for="result_stage1_file">Upload Stage 1 Result Folder:</label>
      <input type="file" id="result_stage1_file" webkitdirectory directory />
    </div>
    <div class="button-group">
      <button id="start_training_button" disabled>Start Training</button>
      <button id="stop_button" disabled>Stop Training</button>
    </div>
    <div id="loading-spinner" class="loading-spinner"></div>
  </div>

  <div class="log-section">
    <h2>Training Output</h2>
    <pre id="output-log" class="log-output"></pre>
  </div>

<div class="below-log">
    <form id="uploadForm" method="POST" enctype="multipart/form-data" action="/upload_file">
      <label for="fileInput">Upload Checkpoints:</label>
      <input type="file" id="fileInput" name="file" webkitdirectory>
    </form>

  <div class="below-log">
    <div class="button-group">
      <button id="converse_button" disabled>Conversation Opener</button>
    </div>
  </div>

  <div id="conversation_section" class="conversation-area">
    <h2>Ask the Model a Question</h2>
    <div class="chat-input-group">
      <input type="text" id="chat_input" placeholder="Type your question..." />
      <button id="send_button">Send</button>
    </div>
    <div id="chat_output" class="chat-output"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const logitsInput = document.getElementById("logits_file_input");
      const stage1Input = document.getElementById("result_stage1_file");
      const startBtn = document.getElementById("start_training_button");
      const stopBtn = document.getElementById("stop_button");
      const converseBtn = document.getElementById("converse_button");
      const spinner = document.getElementById("loading-spinner");
      const outputLog = document.getElementById("output-log");
      const chatInput = document.getElementById("chat_input");
      const sendBtn = document.getElementById("send_button");
      const chatOutput = document.getElementById("chat_output");
      const conversationSection = document.getElementById("conversation_section");

      const colorMap = {
        info: "cyan",
        success: "lightgreen",
        warning: "orange",
        error: "red",
        system: "gray",
        default: "white"
      };

      function detectColor(msg) {
        if (/error|fail|exception/i.test(msg)) return colorMap.error;
        if (/success|completed|done|finished/i.test(msg)) return colorMap.success;
        if (/warn|deprecated/i.test(msg)) return colorMap.warning;
        if (/epoch|step|progress|training/i.test(msg)) return colorMap.info;
        if (/END OF STREAM|stopping/i.test(msg)) return colorMap.system;
        return colorMap.default;
      }

      function updateLog(msg) {
        const now = new Date().toLocaleTimeString();
        const span = document.createElement("span");
        span.style.color = detectColor(msg);
        span.textContent = `[${now}] ${msg}\n`;
        outputLog.appendChild(span);
        outputLog.scrollTop = outputLog.scrollHeight;
      }

      function checkInputs() {
        startBtn.disabled = !(logitsInput.files.length && stage1Input.files.length);
      }

      logitsInput.addEventListener("change", checkInputs);
      stage1Input.addEventListener("change", checkInputs);

      function showSpinner() { spinner.style.display = "block"; }
      function hideSpinner() { spinner.style.display = "none"; }

      async function uploadFile(file, type) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("file_type", type);
        const response = await fetch(`${window.location.origin}/upload_file`, {
          method: "POST",
          body: formData,
        });
        const result = await response.json();
        if (!response.ok || result.status !== "success") {
          throw new Error(result.message || "Upload failed");
        }
        updateLog(`Uploaded ${file.name}`);
        return file.name;
      }

      let eventSource = null;

      startBtn.addEventListener("click", async () => {
        const logitsFile = logitsInput.files[0];
        const stage1Files = Array.from(stage1Input.files);
        if (!logitsFile || !stage1Files.length) {
          alert("Please select both logits file and Stage 1 result folder.");
          return;
        }
        startBtn.disabled = true;
        stopBtn.disabled = false;
        showSpinner();
        updateLog("Starting Stage 2 training...");

        try {
          const logitsPath = await uploadFile(logitsFile, "teacher_logits");
          const stage1FolderName = stage1Files[0].webkitRelativePath.split("/")[0];
          updateLog(`Uploading Stage 1 folder: ${stage1FolderName}`);
          for (const file of stage1Files) await uploadFile(file, "stage1_model");

          const response = await fetch(`${window.location.origin}/start_training`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              logits_path: logitsPath,
              stage1_result_path: stage1FolderName,
            }),
          });
          const result = await response.json();
          if (!response.ok || result.status !== "success") throw new Error(result.message);
          updateLog(result.message);
          converseBtn.disabled = false;

          eventSource = new EventSource(`${window.location.origin}/stream_training_output`);
          eventSource.onmessage = (e) => {
            const data = e.data.trim();
            if (data === "[END]") {
              updateLog("--- END OF STREAM ---");
              eventSource.close();
              stopBtn.disabled = true;
              startBtn.disabled = false;
              hideSpinner();
            } else if (data) updateLog(data);
          };
        } catch (err) {
          updateLog("Error: " + err.message);
          alert(err.message);
          hideSpinner();
          startBtn.disabled = false;
        }
      });

      stopBtn.addEventListener("click", async () => {
        updateLog("Stopping training...");
        try {
          const response = await fetch(`${window.location.origin}/stop_training`, { method: "POST" });
          const result = await response.json();
          updateLog(result.message);
          updateLog("--- END OF STREAM ---");
          if (eventSource) eventSource.close();
        } catch {
          updateLog("Error stopping training.");
        } finally {
          stopBtn.disabled = true;
          startBtn.disabled = false;
          hideSpinner();
        }
      });

      converseBtn.addEventListener("click", () => {
        conversationSection.style.display = "block";
        updateLog("Conversation mode enabled.");
      });

      sendBtn.addEventListener("click", async () => {
        const question = chatInput.value.trim();
        if (!question) return;
        chatOutput.textContent = "Thinking...\n";
        const response = await fetch(`${window.location.origin}/converse`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question }),
        });
        const data = await response.json();
        chatOutput.textContent =
          data.status === "success"
            ? `You: ${question}\nModel: ${data.response}`
            : `Error: ${data.message}`;
        chatInput.value = "";
      });
    });
  </script>
</body>
</html>

